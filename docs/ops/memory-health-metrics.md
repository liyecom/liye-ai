# Memory Health Metrics (MAAP)

**Frozen**: 2026-02-08
**Scope**: liye_os MAAP governance observability
**Update Cadence**: Weekly (every Monday 09:00 UTC)

## Core KPIs

### 1. Observation Rejection Rate

**Definition**: Percentage of observation writes rejected during validation.

- **Event**: `MAAP_OBSERVATION_REJECTED` (from `.liye/logs/test-compliance.jsonl`)
- **Formula**: `rejected_count / (rejected_count + successful_count)` or absolute if no success count
- **Healthy Range**: < 5% (per 7-day window)
- **Alert Threshold**: ≥ 10%

> **⚠️ 分母可信性说明**：
> - 当 `MAAP_OBSERVATION_SAVED` 事件尚未记录时，分母 = rejected_count only
> - 此时 Rejection Rate 会显示 `100%`，这是**数据不完整**，不是系统雪崩
> - 当写入成功事件被记录后，Rate 才可作为决策依据
> - 在此之前，请使用 **Rejected Count per Day** 作为主要指标

**Example Rejection Reasons**:
- `content must be string with length >= 10`
- `integrity_status=REJECTED requires governance_reason`
- `missing_fields` (session_id, source_prompt_id, entities)

### 2. Legacy Observation Detection Rate

**Definition**: Observations filtered due to `legacy_untrusted` status.

- **Event**: `MAAP_OBSERVATION_LEGACY_DETECTED` (from `.liye/logs/test-compliance.jsonl`)
- **Formula**: `legacy_count / total_search_queries` or absolute count
- **Healthy Range**: < 2% of searches encounter legacy filtering
- **Alert Threshold**: ≥ 5%

**Note**: High legacy rate indicates outdated observations in store; consider cleanup.

### 3. Governance Rejection Type Distribution

**Definition**: Breakdown of rejection reasons.

- **Source**: `invalid_fields`, `missing_fields` from `MAAP_OBSERVATION_REJECTED`
- **Output**: Top 3 failure reasons (e.g., "content too short", "missing entities")
- **Action**: If >30% of rejections are single type, investigate root cause

## Derived Metrics (Optional)

- **System Availability**: `1 - (failed_writes / total_writes)`
- **Validation Failure Cost**: `rejected_count * avg_payload_size`
- **Compliance Drift**: Trend of rejection_rate over 4-week window

## Data Source

**Log Location**: `.liye/logs/test-compliance.jsonl`
**Format**: JSON Lines (one event per line)
**Fields**:
- `event`: Event type (string)
- `timestamp`: ISO 8601 timestamp
- `session_id`: Associated session (nullable)
- `source_prompt_id`: Source for traceability
- `invalid_fields` / `missing_fields`: Reason details (array)
- `governance_reason`: Human-readable failure reason

## Reporting Cadence

**Weekly Report** (every Monday 09:00 UTC):
- Generated by: `node scripts/ops/memory-health.mjs --days 7`
- Artifacts: `.json` (metrics), `.md` (human-readable)
- Audience: MAAP maintainers, governance review
- Escalation: If any KPI exceeds alert threshold

## Future Extensions (Out of Scope for Step 6)

- Real-time dashboard (requires UI)
- Storage backend health checks
- Integration with external observability (Datadog, etc.)
- Prediction models (ML-based anomaly detection)
