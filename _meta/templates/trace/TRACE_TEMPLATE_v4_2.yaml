# =============================================================================
# TRACE Template v4.2 - Amazon Growth OS
# =============================================================================
# Enhancement 1: trace_type_profiles - 不同类型有不同必须字段
# Enhancement 3: Evidence Pointer - 可审计的证据链
# Enhancement 4: Multi-tenant - 多店铺/多站点支持
# =============================================================================

trace:
  # === Core Identity ===
  id: "TRACE-YYYYMMDD-001"
  created_at: "YYYY-MM-DDTHH:MM:SSZ"
  agent_id: "trace-scribe"
  trace_type: "decision"  # decision | observation | hypothesis | verification

  # === Enhancement 4: Multi-tenant Support ===
  tenant:
    store_id: "DEMO_STORE"        # 店铺ID (replace with actual)
    marketplace: "US"             # US | CA | EU | UK | DE | FR | JP
    currency: "USD"
    timezone: "America/Los_Angeles"

  entity:
    asin: "B0XXXX"
    sku: "DEMO-SKU-001"
    intent_bucket_id: "IB-prevent-mud-tracking"
    campaign_id: null             # 可选

  # === Enhancement 3: Evidence Pointer (可审计证据链) ===
  evidence:
    - uri: "uploads/DEMO-US/search_terms_20250102.xlsx"
      sha256: "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
      captured_at: "2025-01-02T08:00:00Z"
      note: "Amazon 搜索词报告，1月前7天"
    - uri: "uploads/DEMO-US/广告活动_20250102.xlsx"
      sha256: "FILL_HASH_HERE"
      captured_at: "2025-01-02T08:00:00Z"
      note: "广告活动报表"

  # === Layer 1: Observation ===
  observation:
    trigger: "weekly_check"       # weekly_check | anomaly_alert | manual | scheduled
    data_sources: []              # legacy field, prefer evidence[]
    key_metrics:
      weekly_acos: null
      weekly_conversions: null
      weekly_impressions: null
      weekly_clicks: null
      ctr: null
      cvr: null
    anomalies: []

  # === Layer 2: Analysis ===
  analysis:
    hypotheses_considered:
      - id: "H-001"
        statement: ""
        confidence: 0.50
    priority_scores_used:
      formula: "PS = base(X) × intent_fit(Y) × rufus(Z)"
      base_score: null
      intent_fit: null
      rufus_factor: null
      result: null
      confidence: null
    patterns_matched: []

  # === Layer 3: Decision ===
  decision:
    intent_bucket_id: "IB-prevent-mud-tracking"
    action_type: "bid_decrease"   # bid_increase | bid_decrease | pause | resume | add_keyword | negate_keyword | content_update
    options_considered:
      - option: "A"
        description: ""
        expected_outcome: {}
        risk: "low"
      - option: "B"
        description: ""
        expected_outcome: {}
        risk: "medium"
    selected_option: "A"
    rationale: ""

  # === Layer 4: Execution ===
  execution:
    changes:
      - target: "campaign/XXX/ad_group/YYY/keyword/ZZZ"
        change_type: "bid_decrease"
        from_value: null
        to_value: null
        change_pct: null
    guardrail_check: "PASS"       # PASS | BLOCK | ESCALATE
    guardrail_details:
      trace_exists: true
      amplitude: "PASS"
      batch: "PASS"
      freeze: "PASS"
      hypothesis: "PASS"
    approved_by: null             # null = auto, "liye" = human
    executed_at: null

  # === Layer 5: Hypothesis ===
  hypothesis:
    hypothesis_id: "H-001"
    statement: ""
    expected_outcome:
      acos_change: "< -0.10"
      impressions_change: "> -0.20"
    verification_window_days: 7
    success_criteria:
      - metric: "acos"
        operator: "<"
        value: 0.42

  # === Layer 6: Verification (后续填充) ===
  verification:
    verified_at: null
    actual_outcome: null
    hypothesis_result: null       # confirmed | rejected | inconclusive
    learning: null
    confidence_adjustment: null

  # === Layer 7: Causal Links ===
  causal_links:
    caused_by: null               # 前置 TRACE ID
    causes: []                    # 后续 TRACE IDs
    related_traces: []

# =============================================================================
# Enhancement 1: Trace Type Profiles (最小字段集)
# =============================================================================
# 不同 trace_type 的必须字段不同，避免"编造字段"
#
# trace_type: observation
#   REQUIRED: id, created_at, agent_id, trace_type, tenant, entity, evidence, observation
#   OPTIONAL: analysis (可以有初步分析)
#   FORBIDDEN: decision, execution (不决策)
#
# trace_type: hypothesis
#   REQUIRED: id, created_at, agent_id, trace_type, tenant, hypothesis
#   OPTIONAL: observation, analysis, evidence
#   FORBIDDEN: decision, execution (只提假设)
#
# trace_type: decision
#   REQUIRED: ALL LAYERS (完整决策轨迹)
#
# trace_type: verification
#   REQUIRED: id, created_at, agent_id, trace_type, tenant, verification
#   REQUIRED: hypothesis (指向原假设)
#   OPTIONAL: causal_links
#   NOTE: 通常是补充填充到原 decision trace 的 verification 层
# =============================================================================
