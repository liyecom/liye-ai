#!/usr/bin/env bash
# LiYe OS Pre-commit Hook
# Âú®ÊØèÊ¨° git commit ÂâçËá™Âä®ËøêË°åÊ£ÄÊü•

set -euo pipefail

echo "üîç LiYe OS Pre-commit Checks..."
echo ""

# Check 1: Guardrail (file size limits)
echo "üìè Checking CLAUDE.md and Packs size limits..."
if ! node .claude/scripts/guardrail.mjs; then
  echo ""
  echo "‚ùå Commit blocked: Guardrail check failed"
  echo "   Fix the issues above and try again"
  exit 1
fi

# Check 2: Prevent .DS_Store
if git diff --cached --name-only | grep -q "\.DS_Store"; then
  echo ""
  echo "‚ùå Commit blocked: Attempting to commit .DS_Store files"
  echo "   Run: find . -name .DS_Store -delete"
  exit 1
fi

# Check 3: Prevent large files (>10MB)
large_files=$(git diff --cached --name-only | while read file; do
  if [ -f "$file" ]; then
    size=$(wc -c < "$file" 2>/dev/null || echo 0)
    if [ "$size" -gt 10485760 ]; then
      echo "$file ($(numfmt --to=iec-i --suffix=B $size 2>/dev/null || echo $size bytes))"
    fi
  fi
done)

if [ -n "$large_files" ]; then
  echo ""
  echo "‚ùå Commit blocked: Attempting to commit large files (>10MB):"
  echo "$large_files"
  echo "   Use Git LFS or move to external storage (~/data)"
  exit 1
fi

# Check 4: Prevent data files (except allowed paths)
# Allow: Skills/**/ui-ux/data/ (public reference data)
data_files=$(git diff --cached --name-only | grep -E "\.(csv|xlsx|xls|db|sqlite|duckdb)$" | grep -v "Skills/.*/ui-ux/data/" || true)
if [ -n "$data_files" ]; then
  echo "$data_files"
  echo ""
  echo "‚ùå Commit blocked: Attempting to commit data files"
  echo "   Data files should be in data_external/ (gitignored)"
  echo "   Allowed exception: Skills/**/ui-ux/data/"
  exit 1
fi

# Check 5: Prevent venv
if git diff --cached --name-only | grep -E "venv/|\.venv/|node_modules/"; then
  echo ""
  echo "‚ùå Commit blocked: Attempting to commit virtual environment"
  echo "   Ensure .gitignore includes venv/, .venv/, node_modules/"
  exit 1
fi

# Check 6: Prevent .env files
if git diff --cached --name-only | grep -E "^\.env$|/\.env$"; then
  echo ""
  echo "‚ùå Commit blocked: Attempting to commit .env file"
  echo "   Sensitive data should not be committed"
  echo "   Use .env.example instead"
  exit 1
fi

echo ""
echo "‚úÖ All pre-commit checks passed"

# ===== Block staged secrets/runtime/data (hard gate) =====
echo "üßØ Checking staged files for forbidden patterns..."

# Only check Added/Modified files, not Deleted (--diff-filter=AM)
STAGED="$(git diff --cached --name-only --diff-filter=AM)"

# 1) Hard block: env / keys (but allow .env.example)
echo "$STAGED" | grep -E '(^|/)\.env$|(^|/)\.env\.local$|(^|/)\.env\.production$' >/dev/null && {
  echo "‚ùå Blocked: .env file is staged. Remove it from staging:"
  echo "   git restore --staged <path-to-env>"
  exit 1
}

# 2) Hard block: runtime & heavy artifacts
echo "$STAGED" | grep -E '(^|/)node_modules/|(^|/)venv/|(^|/)\.venv/|\.duckdb$|\.sqlite$|\.db$' >/dev/null && {
  echo "‚ùå Blocked: runtime/db artifact staged."
  exit 1
}

# 3) Hard block: data files & uploads (privacy)
# Exception: Skills/**/ui-ux/data/ (public reference data)
blocked_data=$(echo "$STAGED" | grep -E '\.csv$|\.xlsx$|\.xls$|(^|/)uploads/' | grep -v "Skills/.*/ui-ux/data/" || true)
if [ -n "$blocked_data" ]; then
  echo "‚ùå Blocked: data file or uploads/ staged."
  echo "$blocked_data"
  exit 1
fi

echo "‚úÖ Staged file gate passed"

# ===== Blocklist scan (customer IDs / real ASINs / key prefixes) =====
echo "üõ°Ô∏è Scanning staged files for blocklisted patterns..."

if [ -f ".security/blocklist.txt" ]; then
  # Create temp file with non-comment patterns only
  PATTERNS_TEMP=$(mktemp)
  grep -v "^#" .security/blocklist.txt | grep -v "^$" > "$PATTERNS_TEMP"

  # Get staged file contents and scan for blocklist patterns
  # Exclude security config files themselves
  BLOCKLIST_HITS=""
  while IFS= read -r file; do
    # Skip security config files, pre-commit hook, CI workflows, .gitignore, and UI/UX Skill
    case "$file" in
      .security/*|.claude/.githooks/*|.pre-commit-config.yaml|.github/workflows/amazon-leak-guard.yml|.gitignore) continue ;;
      Skills/*/ui-ux/*|Skills/*/*/ui-ux/*) continue ;;
    esac
    if [ -f "$file" ]; then
      hits=$(grep -Hn -f "$PATTERNS_TEMP" "$file" 2>/dev/null || true)
      if [ -n "$hits" ]; then
        BLOCKLIST_HITS="${BLOCKLIST_HITS}${hits}\n"
      fi
    fi
  done <<< "$STAGED"

  rm -f "$PATTERNS_TEMP"

  if [ -n "$BLOCKLIST_HITS" ]; then
    echo ""
    echo "‚ùå Blocked: Staged files contain blocklisted patterns:"
    echo -e "$BLOCKLIST_HITS"
    echo ""
    echo "   Review .security/blocklist.txt for blocked terms"
    echo "   Remove sensitive data before committing"
    exit 1
  fi
  echo "‚úÖ Blocklist scan passed"
else
  echo "‚ö†Ô∏è .security/blocklist.txt not found, skipping blocklist scan"
fi

exit 0
