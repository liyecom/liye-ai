# =============================================================================
# Trace Governance Gate - GitHub Actions CI
# =============================================================================
# Purpose: Validate trace format and governance compliance for operational changes
# Trigger: PR to main, Push to main
#
# v6.3.0 Updates:
# - traces/ and stats/ are NO LONGER Git-managed SSOT artifacts
# - Gate validates presence/format of trace infrastructure, not raw trace files
# - Absence of runtime traces is acceptable for governance and structure PRs
#
# This gate:
# - Validates trace template and config infrastructure exists
# - Validates TRACE file format IF operational files are changed
# - Does NOT require raw trace files in Git
# =============================================================================

name: Trace Governance Gate

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]

jobs:
  trace-governance:
    name: Trace Governance Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run trace governance checks
        run: |
          echo "=== Trace Governance Gate (v6.3.0) ==="
          echo ""
          echo "Note: traces/ and stats/ are no longer Git-managed."
          echo "This gate validates infrastructure, not raw trace files."
          echo ""

          # Make script executable (in case git didn't preserve)
          # Use canonical path (scripts/ symlink retired in v6.3.0)
          chmod +x tools/trace_guard.sh 2>/dev/null || true

          # Run the guard script from canonical path
          if [[ -f "tools/trace_guard.sh" ]]; then
            bash tools/trace_guard.sh
          else
            echo "WARNING: trace_guard.sh not found at tools/, running inline checks"

            # Inline fallback checks (domain-agnostic)
            ERRORS=0

            # Note: Domain-specific config/agent checks are in private repos.
            # Public repo validates only shared infrastructure.

            # Check 1: TRACE template (canonical path)
            if [[ -f "_meta/templates/trace/TRACE_TEMPLATE_v4_2.yaml" ]]; then
              echo "[PASS] TRACE template exists (canonical path)"
            elif [[ -f "templates/trace/TRACE_TEMPLATE_v4_2.yaml" ]]; then
              echo "[PASS] TRACE template exists (legacy path - consider migration)"
            else
              echo "[FAIL] TRACE template missing"
              ERRORS=$((ERRORS + 1))
            fi

            if [[ $ERRORS -gt 0 ]]; then
              echo ""
              echo "[FAIL] Found $ERRORS error(s)"
              exit 1
            fi

            echo ""
            echo "[PASS] All inline checks passed"
          fi

      - name: Check for TRACE files in PR changes
        if: github.event_name == 'pull_request'
        run: |
          echo "=== Checking PR for operational changes ==="

          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} || true)

          # Check if any operational config was changed (public domains only)
          # Note: amazon-growth checks are in private repo workflow
          OPERATIONAL_CHANGES=$(echo "$CHANGED_FILES" | grep -E "(Agents/skeleton/|src/domain/skeleton/)" || true)

          if [[ -n "$OPERATIONAL_CHANGES" ]]; then
            echo "Operational files changed:"
            echo "$OPERATIONAL_CHANGES"
            echo ""
            echo "INFO: Ensure any operational changes have corresponding TRACE documentation"
          else
            echo "No operational files changed in this PR"
          fi

      - name: Validate TRACE format in PR
        if: github.event_name == 'pull_request'
        run: |
          echo "=== Validating TRACE files in PR ==="

          # Find new/modified TRACE files in the PR
          TRACE_CHANGES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E "TRACE-.*\.(yaml|yml)$" || true)

          if [[ -z "$TRACE_CHANGES" ]]; then
            echo "No TRACE files in this PR (OK)"
            exit 0
          fi

          echo "TRACE files in PR:"
          echo "$TRACE_CHANGES"
          echo ""

          ERRORS=0
          for f in $TRACE_CHANGES; do
            if [[ ! -f "$f" ]]; then
              continue
            fi

            echo "Validating: $f"

            # Required fields check
            if ! grep -qE '^\s*trace:\s*$' "$f"; then
              echo "  [FAIL] Missing 'trace:' top-level key"
              ERRORS=$((ERRORS + 1))
            fi

            if ! grep -qE '^\s+id:\s*["'\'']?TRACE-' "$f"; then
              echo "  [FAIL] Missing 'id: TRACE-*'"
              ERRORS=$((ERRORS + 1))
            fi

            if ! grep -qE '^\s+trace_type:\s*' "$f"; then
              echo "  [FAIL] Missing 'trace_type'"
              ERRORS=$((ERRORS + 1))
            fi

            if ! grep -qE '^\s+guardrail_check:\s*["'\'']?(PASS|BLOCK|ESCALATE)' "$f"; then
              echo "  [WARN] Missing 'guardrail_check' (required for decision type)"
            fi

            echo "  [DONE] $f"
          done

          if [[ $ERRORS -gt 0 ]]; then
            echo ""
            echo "[FAIL] TRACE validation failed with $ERRORS error(s)"
            exit 1
          fi

          echo ""
          echo "[PASS] All TRACE files valid"
