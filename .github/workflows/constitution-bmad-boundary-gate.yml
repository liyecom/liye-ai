name: Constitution - BMad Boundary Gate

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  bmad-boundary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fail if BMAD leaks into Agents runtime layer
        run: |
          set -euo pipefail
          echo "=== Checking BMAD boundary ==="

          # Any BMAD references under Agents/ is forbidden
          if git grep -n -i "bmad" -- "Agents" "agents" 2>/dev/null; then
            echo "::error::BMAD references found under Agents/ or agents/. BMAD must stay in Roles/Context layer only."
            exit 1
          fi

          # Prevent copying BMAD yaml into Agents directories
          if git ls-files | grep -E '^(Agents|agents)/.*\.ya?ml | xargs -I{} bash -lc 'grep -qi "bmad" "{}" && echo "{}" && exit 10' ; then
            echo "::error::BMAD-marked YAML found under Agents/ or agents/. Forbidden."
            exit 1
          fi

          echo "âœ… BMAD boundary OK"
