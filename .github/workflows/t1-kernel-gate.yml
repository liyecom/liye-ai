name: T1 Kernel Non-Regression Gate

on:
  pull_request:
    paths:
      - 'src/kernel/t1/**'
      - 'src/domain/**/t1_candidates/**'

jobs:
  t1-kernel-protection:
    name: Protect T1 Kernel Integrity
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check T1 Kernel Freeze Status
        run: |
          set -euo pipefail
          echo "=== T1 Kernel Non-Regression Gate ==="

          # Rule 1: VERDICT_FREEZE.md must exist and be FROZEN
          if [ ! -f "src/kernel/t1/VERDICT_FREEZE.md" ]; then
            echo "::error::VERDICT_FREEZE.md is missing!"
            exit 1
          fi

          # Match both plain and markdown-formatted Status: FROZEN
          # Handles: "Status: FROZEN" or "**Status**: FROZEN" or "**Status:** FROZEN"
          if ! grep -qE "(Status|^\*\*Status\*?\*?):?\s*FROZEN" src/kernel/t1/VERDICT_FREEZE.md; then
            echo "::error::T1 verdict must remain FROZEN"
            echo "::error::Expected 'Status: FROZEN' or '**Status**: FROZEN' in VERDICT_FREEZE.md"
            exit 1
          fi

          echo "✅ Verdict freeze intact"

      - name: Check T1 Cannot Be Disabled
        run: |
          set -euo pipefail

          # Rule 2: Check for disabling patterns in changed files
          CHANGES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          for file in $CHANGES; do
            if [[ "$file" == src/kernel/t1/* ]]; then
              # Check for deletion of T1 files
              if ! [ -f "$file" ]; then
                echo "::error::T1 kernel files cannot be deleted: $file"
                exit 1
              fi

              # Check for disabling patterns
              if grep -q "status: DISABLED" "$file" 2>/dev/null; then
                echo "::error::T1 cannot be disabled: $file"
                exit 1
              fi
            fi
          done

          echo "✅ No T1 disabling detected"

      - name: Check Always-On T1 Not Demoted
        run: |
          set -euo pipefail

          # Rule 3: Always-on T1 cannot move to contextual/deferred
          # Dynamic: Get current always-on T1s from the directory
          if [ ! -d "src/kernel/t1/always_on" ]; then
            echo "::warning::always_on directory does not exist"
            exit 0
          fi

          ALWAYS_ON_COUNT=$(find src/kernel/t1/always_on -name "T1_*.md" | wc -l | tr -d ' ')
          if [ "$ALWAYS_ON_COUNT" -eq 0 ]; then
            echo "::warning::No always-on T1 files found"
            exit 0
          fi

          echo "Found $ALWAYS_ON_COUNT always-on T1 file(s):"
          for t1_file in src/kernel/t1/always_on/T1_*.md; do
            [ -f "$t1_file" ] || continue
            t1_name=$(basename "$t1_file" .md)
            echo "  ✅ $t1_name is always-on"
          done

          # Check changed files for demotions
          CHANGES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || echo "")
          for file in $CHANGES; do
            if [[ "$file" == src/kernel/t1/contextual/T1_*.md ]] || [[ "$file" == src/kernel/t1/deferred/T1_*.md ]]; then
              t1_name=$(basename "$file" .md)
              # Check if this T1 was previously in always_on
              if git show origin/${{ github.base_ref }}:src/kernel/t1/always_on/${t1_name}.md &>/dev/null; then
                echo "::error::Always-on T1 cannot be demoted: $t1_name"
                exit 1
              fi
            fi
          done

          echo "✅ Always-on T1 classification preserved"

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "==========================================="
          echo "T1 Kernel Non-Regression Gate: PASSED"
          echo "==========================================="
          echo ""
          echo "Protected:"
          echo "- Verdict freeze: INTACT"
          echo "- T1 disabling: BLOCKED"
          echo "- Always-on demotion: BLOCKED"
          echo ""
          echo "T1 is verified as cross-domain reasoning kernel."
          echo "This conclusion cannot be rolled back."
