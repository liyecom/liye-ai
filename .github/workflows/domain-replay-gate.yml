# =============================================================================
# Domain Replay Gate - Regression Testing for ENGINE Changes Only
# =============================================================================
# Purpose: Run replay/regression tests ONLY when ENGINE code changes
#
# Scope: This gate MUST only run when src/domain/**-engine changes:
#   - src/domain/**  (Engines only)
#   - schemas/**     (Contract schemas)
#
# This gate MUST NOT trigger for:
#   - tools/** (Utilities like geo-pipeline)
#   - Systems/** (Services like information-radar)
#   - docs/**
#   - governance changes
#
# Note: Amendment F (v1.7) - Only Engines live in src/domain/
# Note: Geo Pipeline is now a utility in tools/geo-pipeline/ (not subject to this gate)
# Note: Amazon Growth Engine migrated to private repository (2026-01-03)
# =============================================================================

name: Domain Replay Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      # Engine runtime code ONLY
      - 'src/domain/**'
      # Contract schemas that engines depend on
      - 'contracts/schema/**'
      # Replay cases for engines
      - 'replays/geo/cases/**'
      # Engine-related agents
      - 'Agents/geo/**'
      # Replay runner
      - 'tools/geo_os_replay_runner.js'
  push:
    branches: [main]
    paths:
      - 'src/domain/**'
      - 'contracts/schema/**'
      - 'replays/geo/cases/**'
      - 'Agents/geo/**'
      - 'tools/geo_os_replay_runner.js'

jobs:
  # Check if replay tests should run
  check-scope:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if runtime changes
        id: check
        run: |
          # Always run for push to main
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "âœ… Push to main - running replay tests"
            exit 0
          fi

          # For PRs, path filters already handle this
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "âœ… Path filter matched - running replay tests"

  replay-regression:
    needs: check-scope
    if: needs.check-scope.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Run Geo Pipeline Replay Tests
        run: |
          echo "ğŸ” Running Geo Pipeline Replay Tests"
          echo ""
          # Check if replay cases exist
          if [ -d "replays/geo/cases" ]; then
            node tools/geo_os_replay_runner.js replays/geo/cases
          else
            echo "â­ï¸ No Geo Pipeline replay cases found, skipping"
          fi
