name: Architecture Gate (v5.0)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  architecture-gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Detect changed agents and skills
        id: diff
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt

          echo "Changed files:"
          cat changed_files.txt

          # Exclude legacy agents (amazon-growth) and templates from v5.0 validation
          AGENTS=$(grep -E '^Agents/.*\.ya?ml$' changed_files.txt || true)
          AGENTS=$(echo "$AGENTS" | grep -v 'Agents/amazon-growth/' || true)
          AGENTS=$(echo "$AGENTS" | grep -v '_template' || true)
          SKILLS=$(grep -E '^src/.*/skills/' changed_files.txt || true)

          echo "Agents to validate (excluding legacy amazon-growth):"
          echo "$AGENTS"

          echo "agents<<EOF" >> $GITHUB_OUTPUT
          echo "$AGENTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "skills<<EOF" >> $GITHUB_OUTPUT
          echo "$SKILLS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate changed agents
        if: steps.diff.outputs.agents != ''
        run: |
          echo "Validating Agents (YAML schema check)..."
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            echo "-> Checking $file"
            # Validate YAML syntax
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
            # Check required fields for agent definition
            python3 -c "
          import yaml
          with open('$file') as f:
              data = yaml.safe_load(f)
          if data is None:
              print('  ⚠ Empty file, skipping')
              exit(0)
          required = ['role', 'goal', 'backstory']
          missing = [r for r in required if r not in data]
          if missing:
              print(f'  ⚠ Missing fields: {missing} (may be template)')
          else:
              print(f'  ✓ Valid agent definition')
          " || true
          done <<< "${{ steps.diff.outputs.agents }}"
          echo "✓ Agent validation complete"

      - name: Validate changed skills
        if: steps.diff.outputs.skills != ''
        run: |
          echo "Validating Skills (structure check)..."
          echo "${{ steps.diff.outputs.skills }}" | cut -d/ -f1-5 | sort -u | while IFS= read -r dir; do
            [ -z "$dir" ] && continue
            skill=$(basename "$dir")
            echo "-> Checking skill: $skill"
            # Skills should be markdown files with content
            if [ -f "$dir" ] && [ -s "$dir" ]; then
              echo "  ✓ Skill file exists and has content"
            else
              echo "  ⚠ Skill may be empty or directory"
            fi
          done
          echo "✓ Skill validation complete"

      - name: Run Governance Verification
        run: |
          echo "Running governance checks..."
          # Run verify scripts if they exist
          if [ -f "tools/audit/verify_v6_1.py" ]; then
            echo "-> Running verify_v6_1.py"
            python3 tools/audit/verify_v6_1.py || echo "⚠ verify_v6_1 not fully passing"
          fi
          if [ -f "tools/audit/verify_v6_2.py" ]; then
            echo "-> Running verify_v6_2.py"
            python3 tools/audit/verify_v6_2.py || echo "⚠ verify_v6_2 not fully passing"
          fi
          echo "✓ Governance checks complete"
