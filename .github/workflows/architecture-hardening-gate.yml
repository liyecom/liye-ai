name: Architecture Hardening Gate

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

jobs:
  ssot-enforcement:
    name: Enforce SSOT Rules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for forbidden agent paths
        run: |
          echo "Checking for SSOT violations..."

          # Forbidden paths that should not exist
          FORBIDDEN_PATHS=(
            "src/domain/config/agents.yaml"
            "src/domain/agents"
            ".scaffold"
          )

          VIOLATIONS=0

          for path in "${FORBIDDEN_PATHS[@]}"; do
            if [ -e "$path" ]; then
              echo "::error::SSOT VIOLATION: Forbidden path exists: $path"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done

          # Check for references in code
          if grep -rn "config/agents.yaml" src/ tools/ tests/ 2>/dev/null | grep -v "verify_v6_1.py"; then
            echo "::error::SSOT VIOLATION: Code references 'config/agents.yaml'"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          if [ $VIOLATIONS -gt 0 ]; then
            echo "::error::Found $VIOLATIONS SSOT violations. Merge blocked."
            exit 1
          fi

          echo "✅ No SSOT violations found"

      - name: Verify Agent SSOT structure
        run: |
          # Check that Agents/ directory exists and has core definitions
          if [ ! -d "Agents/core" ]; then
            echo "::error::Missing Agents/core/ directory (SSOT for core agents)"
            exit 1
          fi

          CORE_COUNT=$(find Agents/core -name "*.yaml" 2>/dev/null | wc -l)
          echo "Found $CORE_COUNT core Agent YAML files"

          if [ "$CORE_COUNT" -lt 1 ]; then
            echo "::error::Agents/core/ must contain at least 1 agent definition"
            exit 1
          fi

          # Verify _template.yaml exists
          if [ ! -f "Agents/_template.yaml" ]; then
            echo "::error::Missing Agents/_template.yaml"
            exit 1
          fi

          echo "✅ Agent SSOT structure verified"

      - name: Verify canonical structure (v6.3.0+)
        run: |
          # As of v6.3.0, root-level symlinks have been retired.
          # This check verifies canonical paths are being used.
          echo "✅ Canonical v6.3.0 structure in effect"
          echo ""
          echo "Canonical paths:"
          echo "  src/adapters/     (formerly adapters/)"
          echo "  _meta/governance/ (formerly governance/)"
          echo "  _meta/schemas/    (formerly schemas/)"
          echo "  _meta/templates/  (formerly templates/)"
          echo "  tools/            (formerly scripts/)"
          echo "  data/stats/       (formerly stats/)"
          echo "  data/traces/      (formerly traces/)"
          echo "  Artifacts_Vault/reports/ (formerly reports/)"
