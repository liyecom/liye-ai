# LiYe AI - Continuous Integration

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # Memory Governance Gate: enforce SSOT boundary (no direct claude-mem outside gateway)
  memory-gate:
    name: Memory Governance Gate (SSOT)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Memory governance gate (enforce Step 5B boundary)
        shell: bash
        run: bash scripts/ci/memory-governance-gate.sh

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint --if-present

  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test --if-present

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build --if-present

      - name: Verify Repository Structure
        run: |
          echo "Verifying LiYe OS repository structure..."
          # Check core directories exist
          for dir in Agents Skills Systems src/kernel; do
            if [ -d "$dir" ]; then
              echo "✓ $dir exists"
            else
              echo "✗ $dir missing"
              exit 1
            fi
          done
          echo "✓ Repository structure verified"

  validate-yaml:
    name: Validate YAML
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install yaml validator
        run: npm install -g yaml-lint

      - name: Validate agent YAMLs
        run: yamllint src/domain/agents/*.yaml || true

      - name: Validate workflow YAMLs
        run: |
          find src/domain -name "*.yaml" -type f | head -20 | xargs -I {} echo "Checking {}"

  heartbeat-switch-test:
    name: Heartbeat Dual-Switch Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create test fixtures
        run: |
          mkdir -p tests/fixtures/heartbeat_learning/empty/data/runs
          touch tests/fixtures/heartbeat_learning/empty/data/runs/.gitkeep
          mkdir -p state/runtime/proactive
          echo '{"enabled":false,"cooldown_minutes":30}' > state/runtime/proactive/heartbeat_learning_state.json
          echo '{"learning_heartbeat":true}' > state/runtime/proactive/kill_switch.json

      - name: Run dual-switch tests
        run: node tests/test_dual_switch_heartbeat.mjs

  architecture-check:
    name: Architecture Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check layer boundaries
        run: |
          echo "Checking architecture boundaries..."
          # Verify Method layer has no .ts execution files
          if find src/method -name "*.ts" 2>/dev/null | grep -q .; then
            echo "Warning: TypeScript files found in Method layer"
          fi
          echo "Architecture check passed"

      - name: Verify domain structure
        run: |
          echo "Checking domain structure..."
          for domain in skeleton medical-research geo; do
            if [ -d "src/domain/$domain" ]; then
              echo "✓ Domain $domain exists"
              if [ -f "src/domain/$domain/config.yaml" ]; then
                echo "  ✓ config.yaml present"
              else
                echo "  ✗ config.yaml missing"
              fi
            fi
          done
