# Live Site Protection Gate
# Â§4.6 Live vs Example ç«™ç‚¹æ²»ç† - CI å¼ºåˆ¶æ‰§è¡Œ
#
# é˜²æ­¢ Live ç«™ç‚¹ï¼ˆå®¢æˆ·èµ„äº§ï¼‰è¢«æ„å¤–æäº¤åˆ°å…¬å¼€ä»“åº“
# åªæœ‰ example-site/ å…è®¸è¢« tracked

name: Live Site Gate

on:
  pull_request:
    paths:
      - 'websites/**'

jobs:
  check-live-sites:
    name: Block Live Sites from PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Live Site files
        run: |
          echo "ğŸ›¡ï¸ Â§4.6 Live Site Gate - Checking for unauthorized site files..."
          echo ""

          # Get changed files in websites/ directory
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^websites/' || true)

          if [ -z "$CHANGED" ]; then
            echo "âœ… No websites/ changes detected"
            exit 0
          fi

          echo "ğŸ“‚ Changed files in websites/:"
          echo "$CHANGED"
          echo ""

          # Check for Live site files (anything except example-site/, .gitignore, README.md, _templates/)
          LIVE_FILES=$(echo "$CHANGED" | grep -E '^websites/(?!example-site/|\.gitignore$|README\.md$|_templates/)' || true)

          if [ -n "$LIVE_FILES" ]; then
            echo ""
            echo "âŒ BLOCKED: Live site files detected in PR!"
            echo ""
            echo "The following files violate Â§4.6 Live vs Example governance:"
            echo "$LIVE_FILES"
            echo ""
            echo "ğŸ“œ Rule: Only websites/example-site/ may be tracked in this repository."
            echo "         Live sites (kuachu, timomats, refetone, etc.) are customer assets"
            echo "         and must remain gitignored."
            echo ""
            echo "ğŸ”§ Fix: Remove these files from your commit:"
            echo "   git rm -r --cached <path>"
            echo "   git commit --amend"
            exit 1
          fi

          echo "âœ… All websites/ changes are in allowed paths (example-site/, .gitignore, README.md, _templates/)"
