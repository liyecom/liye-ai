/**
 * Execution Result Writer
 *
 * Writes execution_result.json and execution_result.md files
 * into trace directories for audit and review.
 *
 * Week5: Records dry-run execution results with GUARANTEE fields
 */

import { writeFileSync, existsSync, mkdirSync } from 'fs';
import { join } from 'path';

const TRACE_BASE_DIR = process.env.TRACE_BASE_DIR || '.liye/traces';

/**
 * Write Execution Result to trace directory
 *
 * @param {Object} params
 * @param {string} params.trace_id - Trace identifier
 * @param {Object} params.executionResult - Execution result conforming to EXECUTION_RESULT_V1
 * @param {string} params.baseDir - Base directory for traces (optional)
 * @returns {Object} { success, jsonPath, mdPath, error }
 */
export function writeExecutionResult({ trace_id, executionResult, baseDir }) {
  const traceBaseDir = baseDir || TRACE_BASE_DIR;
  const traceDir = join(traceBaseDir, trace_id);

  try {
    // Ensure trace directory exists
    if (!existsSync(traceDir)) {
      mkdirSync(traceDir, { recursive: true });
    }

    // Write JSON
    const jsonPath = join(traceDir, 'execution_result.json');
    writeFileSync(jsonPath, JSON.stringify(executionResult, null, 2), 'utf-8');

    // Write Markdown
    const mdPath = join(traceDir, 'execution_result.md');
    const mdContent = generateExecutionResultMd(executionResult);
    writeFileSync(mdPath, mdContent, 'utf-8');

    console.log(`[ExecutionResultWriter] Generated execution_result at ${traceDir}`);
    return {
      success: true,
      jsonPath,
      mdPath
    };

  } catch (e) {
    console.error('[ExecutionResultWriter] Failed to write:', e.message);
    return { success: false, error: e.message };
  }
}

/**
 * Generate Markdown representation of Execution Result
 */
function generateExecutionResultMd(result) {
  // Build action rows
  const actionRows = result.actions.map((a, i) => {
    const statusEmoji = getStatusEmoji(a.result_status);
    return `| ${i + 1} | ${a.action_type} | \`${a.tool}\` | ${statusEmoji} ${a.result_status} | ${a.reason || '-'} |`;
  }).join('\n');

  // Build summary stats
  const summary = result.summary;
  const successRate = summary.total_actions > 0
    ? Math.round((summary.simulated_actions / summary.total_actions) * 100)
    : 0;

  return `# Execution Result (Dry-Run)

**Trace ID**: \`${result.trace_id}\`
**Plan ID**: \`${result.plan_id}\`
**Executed At**: ${result.executed_at}
**Mode**: ${result.mode === 'dry_run' ? 'üîí Dry-Run (No Real Writes)' : result.mode}

---

## Approval Information

| Field | Value |
|-------|-------|
| **Status** | ‚úÖ ${result.approval.status} |
| **Approved By** | \`${result.approval.reviewed_by}\` |
| **Approved At** | ${result.approval.reviewed_at} |

---

## Execution Summary

| Metric | Count |
|--------|-------|
| **Total Actions** | ${summary.total_actions} |
| **Simulated** | ‚úÖ ${summary.simulated_actions} |
| **Blocked** | üö´ ${summary.blocked_actions} |
| **Skipped** | ‚è≠Ô∏è ${summary.skipped_actions || 0} |
| **Failed** | ‚ùå ${summary.failed_actions || 0} |
| **Success Rate** | ${successRate}% |

> ${summary.notes}

---

## Action Results

| # | Type | Tool | Status | Reason |
|---|------|------|--------|--------|
${actionRows}

---

## Action Details

${result.actions.map((a, i) => `### Step ${i + 1}: ${a.action_type.toUpperCase()} - ${a.tool}

- **Action ID**: \`${a.action_id}\`
- **Status**: ${getStatusEmoji(a.result_status)} **${a.result_status}**
- **Reason**: ${a.reason || 'N/A'}
- **Arguments Hash**: \`${a.arguments_hash}\`

${a.simulated_output ? `**Simulated Output**:
\`\`\`json
${JSON.stringify(a.simulated_output, null, 2)}
\`\`\`` : ''}
`).join('\n')}

---

## Week5 Guarantees

| Guarantee | Value | Status |
|-----------|-------|--------|
| **No Real Write** | ${result.GUARANTEE.no_real_write} | ${result.GUARANTEE.no_real_write ? '‚úÖ Verified' : '‚ùå VIOLATION'} |
| **Write Calls Attempted** | ${result.GUARANTEE.write_calls_attempted} | ${result.GUARANTEE.write_calls_attempted === 0 ? '‚úÖ Zero' : '‚ùå VIOLATION'} |
| **WRITE_ENABLED Env** | ${result.GUARANTEE.write_enabled_env} | ${result.GUARANTEE.write_enabled_env === '0' ? 'üîí Disabled' : '‚ö†Ô∏è Enabled'} |

> **Origin**: \`${result.origin}\`

---

## Links

- **Action Plan**: \`.liye/traces/${result.trace_id}/action_plan.md\`
- **Evidence Package**: \`.liye/traces/${result.trace_id}/evidence_package.md\`
- **Events Log**: \`.liye/traces/${result.trace_id}/events.ndjson\`
- **Approval Status**: \`.liye/traces/${result.trace_id}/approval.json\`

---

*Generated by LiYe OS Execution Result Writer (Week5)*
*Dry-run execution - no real API calls were made*
`;
}

/**
 * Get emoji for result status
 */
function getStatusEmoji(status) {
  switch (status) {
    case 'SIMULATED':
      return '‚úÖ';
    case 'BLOCKED':
      return 'üö´';
    case 'SKIPPED':
      return '‚è≠Ô∏è';
    case 'FAILED':
      return '‚ùå';
    default:
      return '‚ùì';
  }
}

/**
 * Check if execution result exists for a trace
 */
export function executionResultExists(trace_id, baseDir) {
  const traceBaseDir = baseDir || TRACE_BASE_DIR;
  const filePath = join(traceBaseDir, trace_id, 'execution_result.json');
  return existsSync(filePath);
}

/**
 * Get execution result path
 */
export function getExecutionResultPath(trace_id, kind = 'json', baseDir) {
  const traceBaseDir = baseDir || TRACE_BASE_DIR;
  const fileName = kind === 'md' ? 'execution_result.md' : 'execution_result.json';
  return join(traceBaseDir, trace_id, fileName);
}

export default { writeExecutionResult, executionResultExists, getExecutionResultPath };
